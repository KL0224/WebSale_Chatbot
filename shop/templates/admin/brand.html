{% set show_footer = False %}
{% extends "base.html" %}

{% block title %}
{% if title %} {{ title }} {% else %} Brand or Category {% endif %}
{% endblock title %}

{% block content %}
{% include '_messages.html' %}

<div class="container">
    {% include '_navbar_admin.html' %}
</div>

<!-- Main Header -->
<div class="container mt-4 mb-4">
    <div class="d-flex justify-content-between align-items-start">
        <div class="flex-grow-1">
            {% if brands %}
                <h2 class="text-primary fw-bold mb-1">Quản Lý Thương Hiệu</h2>
                <p class="text-muted mb-0">Danh sách và quản lý tất cả thương hiệu trong hệ thống</p>
            {% else %}
                <h2 class="text-primary fw-bold mb-1">Quản Lý Danh Mục</h2>
                <p class="text-muted mb-0">Danh sách và quản lý tất cả danh mục trong hệ thống</p>
            {% endif %}
        </div>
        
        <!-- Search Section -->
        <div class="d-flex align-items-center gap-3 ms-4">
            <div class="search-section d-flex align-items-center gap-2">
                <span class="text-muted fw-medium">Tìm kiếm:</span>
                <div class="search-container">
                    <div class="input-group">
                        {% if brands %}
                            <input type="text" 
                                   class="form-control form-control-sm" 
                                   id="searchInput" 
                                   placeholder="Tìm thương hiệu..." 
                                   style="min-width: 200px;">
                        {% else %}
                            <input type="text" 
                                   class="form-control form-control-sm" 
                                   id="searchInput" 
                                   placeholder="Tìm danh mục..." 
                                   style="min-width: 200px;">
                        {% endif %}
                        <button class="btn btn-outline-secondary btn-sm" type="button" id="clearSearch">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Add Button -->
            <div>
                {% if brands %}
                    <a href="{{ url_for('addbrand') }}" class="btn btn-success px-4 py-2">
                        <i class="fas fa-plus me-2"></i>Thêm Thương Hiệu
                    </a>
                {% else %}
                    <a href="{{ url_for('addcategory') }}" class="btn btn-success px-4 py-2">
                        <i class="fas fa-plus me-2"></i>Thêm Danh Mục
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Results Counter -->
<div class="container mb-3">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            {% if brands %}
                <span id="totalCount" class="text-muted">Tổng cộng: <strong>{{ brands|length }} thương hiệu</strong></span>
                <span id="searchResults" class="text-primary" style="display: none;"></span>
            {% else %}
                <span id="totalCount" class="text-muted">Tổng cộng: <strong>{{ categories|length }} danh mục</strong></span>
                <span id="searchResults" class="text-primary" style="display: none;"></span>
            {% endif %}
        </div>
    </div>
</div>

<!-- Data Table -->
<div class="container">
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            {% if brands %}
                <!-- Brand Table Header -->
                <div class="bg-dark text-white p-3">
                    <div class="row align-items-center fw-bold">
                        <div class="col-1 text-center">STT</div>
                        <div class="col-4">Tên Thương Hiệu</div>
                        <div class="col-7 text-center">Thao Tác</div>
                    </div>
                </div>
                
                <!-- Brand Table Body -->
                <div id="dataTable">
                    {% for brand in brands %}
                    <div class="row align-items-center border-bottom py-3 {% if loop.index % 2 == 0 %}bg-light{% endif %} hover-row data-row" 
                         data-name="{{ brand.name|lower }}">
                        <div class="col-1 text-center">
                            <span class="badge bg-secondary rounded-circle px-2 py-1">{{loop.index}}</span>
                        </div>
                        <div class="col-4">
                            <h6 class="mb-0 fw-semibold item-name">{{brand.name}}</h6>
                        </div>
                        <div class="col-7 text-center">
                            <a href="{{url_for('updatebrand', id=brand.id)}}" class="btn btn-primary btn-sm me-2">
                                <i class="fas fa-edit me-1"></i>Sửa
                            </a>
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#deleteModal-{{brand.id}}">
                                <i class="fas fa-trash me-1"></i>Xóa
                            </button>
                        </div>
                    </div>
                    
                    <!-- Delete Modal for Brand -->
                    <div class="modal fade" id="deleteModal-{{brand.id}}" tabindex="-1"
                         aria-labelledby="deleteModalLabel-{{brand.id}}" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header bg-danger text-white">
                                    <h5 class="modal-title" id="deleteModalLabel-{{brand.id}}">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Xác nhận xóa
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body text-center">
                                    <div class="mb-3">
                                        <i class="fas fa-question-circle text-warning" style="font-size: 3rem;"></i>
                                    </div>
                                    <h6 class="mb-2">Bạn có chắc chắn muốn xóa thương hiệu này?</h6>
                                    <p class="text-muted mb-0">
                                        Thương hiệu: <strong class="text-danger">{{brand.name}}</strong>
                                    </p>
                                    <small class="text-muted">Hành động này không thể hoàn tác!</small>
                                </div>
                                <div class="modal-footer justify-content-center">
                                    <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                                        <i class="fas fa-times me-1"></i>Hủy
                                    </button>
                                    <form action="{{url_for('deletebrand', id=brand.id)}}" method="POST" class="d-inline">
                                        <button type="submit" class="btn btn-danger">
                                            <i class="fas fa-trash me-1"></i>Xóa
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- Category Table Header -->
                <div class="bg-dark text-white p-3">
                    <div class="row align-items-center fw-bold">
                        <div class="col-1 text-center">STT</div>
                        <div class="col-4">Tên Danh Mục</div>
                        <div class="col-7 text-center">Thao Tác</div>
                    </div>
                </div>
                
                <!-- Category Table Body -->
                <div id="dataTable">
                    {% for category in categories %}
                    <div class="row align-items-center border-bottom py-3 {% if loop.index % 2 == 0 %}bg-light{% endif %} hover-row data-row"
                         data-name="{{ category.name|lower }}">
                        <div class="col-1 text-center">
                            <span class="badge bg-secondary rounded-circle px-2 py-1">{{loop.index}}</span>
                        </div>
                        <div class="col-4">
                            <h6 class="mb-0 fw-semibold item-name">{{category.name}}</h6>
                        </div>
                        <div class="col-7 text-center">
                            <a href="{{url_for('updatecat', id=category.id)}}" class="btn btn-primary btn-sm me-2">
                                <i class="fas fa-edit me-1"></i>Sửa
                            </a>
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#deleteModal-{{category.id}}">
                                <i class="fas fa-trash me-1"></i>Xóa
                            </button>
                        </div>
                    </div>
                    
                    <!-- Delete Modal for Category -->
                    <div class="modal fade" id="deleteModal-{{category.id}}" tabindex="-1"
                         aria-labelledby="deleteModalLabel-{{category.id}}" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header bg-danger text-white">
                                    <h5 class="modal-title" id="deleteModalLabel-{{category.id}}">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Xác nhận xóa
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body text-center">
                                    <div class="mb-3">
                                        <i class="fas fa-question-circle text-warning" style="font-size: 3rem;"></i>
                                    </div>
                                    <h6 class="mb-2">Bạn có chắc chắn muốn xóa danh mục này?</h6>
                                    <p class="text-muted mb-0">
                                        Danh mục: <strong class="text-danger">{{category.name}}</strong>
                                    </p>
                                    <small class="text-muted">Hành động này không thể hoàn tác!</small>
                                </div>
                                <div class="modal-footer justify-content-center">
                                    <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                                        <i class="fas fa-times me-1"></i>Hủy
                                    </button>
                                    <form action="{{url_for('deletecat', id=category.id)}}" method="POST" class="d-inline">
                                        <button type="submit" class="btn btn-danger">
                                            <i class="fas fa-trash me-1"></i>Xóa
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
            
            <!-- No results message -->
            <div id="noResultsMessage" class="text-center py-5" style="display: none;">
                <i class="fas fa-search text-muted" style="font-size: 3rem;"></i>
                {% if brands %}
                    <h5 class="text-muted mt-3">Không tìm thấy thương hiệu nào</h5>
                {% else %}
                    <h5 class="text-muted mt-3">Không tìm thấy danh mục nào</h5>
                {% endif %}
                <p class="text-muted">Hãy thử từ khóa khác hoặc xóa bộ lọc</p>
            </div>
        </div>
    </div>
</div>

<!-- Custom CSS for hover effects and search -->
<style>
/* Tắt thanh cuộn ngang */
body {
    overflow-x: hidden;
}

.container {
    overflow-x: hidden;
}

.table-container {
    overflow-x: auto;
    max-width: 100%;
}

.table {
    min-width: 100%;
    margin-bottom: 0;
}

.table td {
    white-space: nowrap;
    border-top: 1px solid #dee2e6;
    vertical-align: middle;
}

.table tr:hover {
    background-color: #f8f9fa !important;
}

.hover-row {
    transition: all 0.2s ease;
}

.hover-row:hover {
    background-color: #f8f9fa !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card {
    border-radius: 10px;
    overflow: hidden;
}

.badge {
    font-size: 0.75rem;
}

.btn {
    border-radius: 6px;
    font-weight: 500;
}

.modal-content {
    border-radius: 10px;
    border: none;
}

.modal-header {
    border-bottom: none;
}

.modal-footer {
    border-top: none;
    padding-top: 0;
}

.search-container {
    position: relative;
}

.search-container .input-group {
    border-radius: 0.375rem;
    overflow: hidden;
}

.search-container .form-control {
    border-right: none;
}

.search-container .btn {
    border-left: none;
    background-color: #f8f9fa;
}

.search-container .btn:hover {
    background-color: #e9ecef;
}

.search-section {
    white-space: nowrap;
}

.highlight {
    background-color: #fff3cd;
    padding: 1px 3px;
    border-radius: 3px;
}

.data-row.filtered {
    display: none;
}
</style>

<!-- Search functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearch');
    const dataRows = document.querySelectorAll('.data-row');
    const totalCount = document.getElementById('totalCount');
    const searchResults = document.getElementById('searchResults');
    const noResultsMessage = document.getElementById('noResultsMessage');
    const dataTable = document.getElementById('dataTable');
    
    {% if brands %}
        const totalItems = {{ brands|length }};
        const itemType = 'thương hiệu';
    {% else %}
        const totalItems = {{ categories|length }};
        const itemType = 'danh mục';
    {% endif %}

    function performSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        let visibleCount = 0;

        // Clear previous highlights
        document.querySelectorAll('.highlight').forEach(el => {
            el.outerHTML = el.innerHTML;
        });

        dataRows.forEach(row => {
            const itemName = row.getAttribute('data-name');
            
            if (searchTerm === '' || itemName.includes(searchTerm)) {
                row.style.display = '';
                visibleCount++;

                // Highlight matching text
                if (searchTerm !== '') {
                    highlightText(row.querySelector('.item-name'), searchTerm);
                }
            } else {
                row.style.display = 'none';
            }
        });

        // Update result counter
        if (searchTerm === '') {
            totalCount.style.display = '';
            searchResults.style.display = 'none';
            noResultsMessage.style.display = 'none';
            dataTable.style.display = '';
        } else {
            totalCount.style.display = 'none';
            searchResults.style.display = '';
            searchResults.textContent = `Tìm thấy: ${visibleCount} ${itemType}`;
            
            if (visibleCount === 0) {
                noResultsMessage.style.display = 'block';
                dataTable.style.display = 'none';
            } else {
                noResultsMessage.style.display = 'none';
                dataTable.style.display = '';
            }
        }
    }

    function highlightText(element, searchTerm) {
        if (!element) return;
        
        const text = element.textContent;
        const regex = new RegExp(`(${searchTerm})`, 'gi');
        const highlightedText = text.replace(regex, '<span class="highlight">$1</span>');
        element.innerHTML = highlightedText;
    }

    // Event listeners
    searchInput.addEventListener('input', performSearch);
    searchInput.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });

    clearSearchBtn.addEventListener('click', function() {
        searchInput.value = '';
        performSearch();
        searchInput.focus();
    });

    // Show/hide clear button based on input
    searchInput.addEventListener('input', function() {
        clearSearchBtn.style.display = this.value ? 'block' : 'none';
    });

    // Initialize clear button visibility
    clearSearchBtn.style.display = 'none';
});
</script>

{% endblock content %}